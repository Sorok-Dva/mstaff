<link rel="stylesheet" href="/assets/css/telinput/intlTelInput.css">
<style>
  .iti-flag {
    background-image: url("/assets/images/telinput/flags.png");
  }
  @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
    .iti-flag {
      background-image: url("/assets/images/telinput/flags@2x.png");
    }
  }
  /* Container */
  .container {
    margin: 0 auto;
    border: 0px solid black;
    width: 50%;
    height: 250px;
    border-radius: 3px;
    background-color: ghostwhite;
    text-align: center;
  }

  /* Preview */
  .preview {
    width: 100px;
    height: 100px;
    border: 1px solid black;
    margin: 0 auto;
    background: white;
  }

  .preview img {
    display: none;
  }
  .author {
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  /* Button */
  .button {
    border: 0px;
    background-color: deepskyblue;
    color: white;
    padding: 5px 15px;
    margin-left: 10px;
  }
</style>
<div class="row">
  <div class="col-lg-4 col-md-5">
    <div class="card card-user">
      <div class="image"></div>
      <div class="content">
        <div class="author">
          <div style="padding-top: 10px;">
            <div class="avatar avatar-xxl">
              <img id="candidateAvatar" {{#if usr.photo}} src="/uploads/avatars/{{usr.photo}}" {{else}} src="/assets/images/face-0.jpg" {{/if}} class="avatar-img rounded-circle border-black" alt="avatar">
          </div>
        </div>
        <form id="avatarForm" action="/api/candidate/add/photo?_csrf={{csrfToken}}" method="post" enctype="multipart/form-data">
          <span id="editAvatar" class="btn btn-default btn-file rounded-circle" style="border: 1px solid black; margin-top: -42px; background-color: white;">
              <i class="fal fa-camera-alt"></i> <input type="file" id="imgInp" name="avatar" onchange="avatarSelected()">
            </span>
          <button id="validateAvatarButton" type="submit" class="btn btn-primary" style="display:none"> Valider </button>
        </form>
          <h4 class="title">{{usr.firstName}} {{usr.lastName}}<br/>
          </h4>
        </div>
        <p class="description text-center ml-1 mr-1">
          {{usr.candidate.description}}
        </p>
      </div>
      <hr>
      <div class="text-center">
        <div class="row">
          <div class="col-6 col-md-offset-1">
            <h5>{{date usr.createdAt 'DD/MM/YY'}}<br/>
              <small>Inscription</small>
            </h5>
          </div>
          <div class="col-6">
            <h5>{{date usr.updatedAt 'DD/MM/YY'}}<br/>
              <small>Dernière modification</small>
            </h5>
          </div>
          <div class="col-md-12" style="padding: 20px 0px 10px;">
            <button class="btn btn-info btn-fill btn-wd" id="changePass">
              Modifier mon mot de passe
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-lg-8 col-md-7">
    <div class="card">
      <div class="card-header">
        <h4 class="title">Modifier le profil</h4>
      </div>
      <div class="card-content" style="padding: 20px;">
        <form id="profileForm" method="post" action="/profile/edit">
          <div class="row">
            <div class="col-md-3">
              <div class="form-group">
                <label>Prénom</label>
                <input type="text" name="firstName" class="form-control border-input" placeholder="Prénom"
                       value="{{usr.firstName}}" required>
              </div>
            </div>
            <div class="col-md-3">
              <div class="form-group">
                <label>Nom</label>
                <input type="text" name="lastName" class="form-control border-input" placeholder="Nom"
                       value="{{usr.lastName}}" required>
              </div>
            </div>
            <div class="col-md-3">
              <div class="form-group">
                <label for="exampleInputEmail1">Adresse email</label>
                <input type="email" name="email" class="form-control border-input" placeholder="Email"
                       value="{{usr.email}}" required>
              </div>
            </div>
            <div class="col-md-3">
              <div class="form-group">
                <label>Date de naissance</label>
                <input id="birthdayEdit" type="text" class="form-control border-input" placeholder="dd/mm/aaaa"
                       value="{{date usr.birthday 'DD MM YYYY'}}" required>
                <input id="birthdayHidden" type="hidden" name="birthday" value="{{date usr.birthday 'YYYY-MM-DD'}}" required>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-md-4">
              <div class="form-group">
                <label for="phone">{{tr.pages.register.form_phoneNumber_label}}</label>
                <input id="phone" name="phone" type="tel" placeholder="{{tr.pages.register.form_phoneNumber_label_ph}}"
                       class="form-control" value="{{usr.phone}}" required="">
              </div>
            </div>
            <div class="col-md-2">
              <div class="form-group">
                <label>Code Postal</label>
                <input type="text" name="postal_code" class="form-control border-input" placeholder="Code Postal"
                       value="{{usr.postal_code}}" required>
              </div>
            </div>
            <div class="col-md-3">
              <div class="form-group">
                <label>Ville</label>
                <input type="text" name="town" class="form-control border-input" placeholder="Ville"
                       value="{{usr.town}}" required>
              </div>
            </div>
            <div class="col-md-3">
              <div class="form-group">
                <label>Pays</label>
                <input type="text" id="countryCode" name="country" class="form-control border-input" placeholder="Pays"
                       value="{{usr.country}}" required>
              </div>
            </div>
          </div>
          {{#if usr.candidate}}
            <div class="row">
              <div class="col-md-12">
                <div class="form-group">
                  <label>Mes motivations</label>
                  <textarea rows="5" name="description"
                            class="form-control border-input">{{usr.candidate.description}}</textarea>
                </div>
              </div>
            </div>
          {{/if}}
          <input type="hidden" name="_csrf" value="{{csrfToken}}"/>
          <div class="text-center">
            <button type="submit" class="btn btn-info btn-fill btn-wd">Modifier le profil</button>
          </div>
          <p id="removeAccount" class="text-muted text-center mt-2" style="cursor: pointer" onclick="deleteAccount()">Supprimer mon compte</p>
          <div class="clearfix"></div>
        </form>
      </div>
    </div>
  </div>
</div>
<script src="/assets/js/telinput/intlTelInput.js"></script>
<script src="/assets/dist/js/candidate/uploadPhoto.min.js"></script>
<script>
  $(document).ready(function () {
    let input = document.querySelector("#phone");
    window.intlTelInput(input);

    $('#profileForm').submit( e => $('#birthdayEdit').val());

    $('#birthdayEdit').datetimepicker({
      format: 'DD MM YYYY'
    });

    $('#birthdayEdit').on('dp.change',  function (){
      let value = moment($('#birthdayEdit').data("DateTimePicker").date()).format('YYYY-MM-DD');
      $('#birthdayHidden').val(value);
    });

  });
  let deleteAccount = () => {
    createModal({
      id: 'removeAccountModal',
      title: 'Supprimer mon compte',
      modal: 'candidate/removeAccount'
    });
  };
  $('#changePass').click(function () {
    createModal({
      id: 'changePassword',
      title: 'Modifier votre mot de passe',
      modal: 'candidate/changePassword'
    }, () => {
      $('button#ChangePassValidation').click(function () {
        if ($('input#newPassword').val() != '' && $('input#newPasswordVerification').val() != '' && $('input#oldPassword').val() != '') {
          let _csrf = $('meta[name="csrf-token"]').attr('content');
          let newPassword = $('input#newPassword').val();
          let newPasswordVerification = $('input#newPasswordVerification ').val();
          let oldPassword = $('input#oldPassword ').val();

          $.post(`/profile/passwordReset`, {
            oldPassword,
            newPassword,
            newPasswordVerification,
            _csrf
          }, (response) => {
            console.log(response);
            if (response.status === 'invalid password') {
              $('input#oldPassword').addClass('is-invalid');
              setTimeout(function () {
                $('input#oldPassword').removeClass('is-invalid');
              }, 2000);
              notification({
                icon: 'exclamation',
                type: 'danger',
                title: `Votre mot de passe est invalide`,
                message: ``
              });
            }
            if (response.status === 'new password cannot be your old password') {
              $('input#oldPassword').addClass('is-invalid');
              $('input#newPassword').addClass('is-invalid');
              $('input#newPasswordVerification').addClass('is-invalid');
              setTimeout(function () {
                $('input#oldPassword').removeClass('is-invalid');
                $('input#newPassword').removeClass('is-invalid');
                $('input#newPasswordVerification').removeClass('is-invalid');
              }, 2000);
              notification({
                icon: 'exclamation',
                type: 'danger',
                title: `Votre nouveau mot de passe ne peut pas etre identique à l'ancien`,
                message: ``
              });
            }
            if (response.status === 'password verification is incorrect') {
              $('input#newPassword').addClass('is-invalid');
              $('input#newPasswordVerification').addClass('is-invalid');
              setTimeout(function () {
                $('input#newPassword').removeClass('is-invalid');
                $('input#newPasswordVerification').removeClass('is-invalid');
              }, 2000);
              notification({
                icon: 'exclamation',
                type: 'danger',
                title: `La vérification de votre mot de passe a échoué`,
                message: ``
              });
            }
            if (response.status === 'ok') {
              $('#changePassword').modal('hide');
            }
          });
        }
      });
    });
  });
</script>

