<link href="https://gitcdn.github.io/bootstrap-toggle/2.2.2/css/bootstrap-toggle.min.css" rel="stylesheet">
<script src="https://gitcdn.github.io/bootstrap-toggle/2.2.2/js/bootstrap-toggle.min.js"></script>

<style>
  .class-icon {
    text-align: center;
    margin-top: 15px;
  }
  .header-spacing {
    margin-top: 15px;
  }
  .toggle.ios, .toggle-on.ios, .toggle-off.ios {
    border-radius: 20px;
    background-color: #D8D8D8;
  }
</style>

{{#ifCond pools.length '<=' 0}}
  <div class="col-md-12 text-center">
    <h2 style="font-weight: 400"> Vous n'avez pas encore crée de pool de remplaçants. </h2>
  </div>
{{/ifCond}}

<div class="row">
  <div class="col-12 col-md-12 col-lg-12" style="margin-bottom: 25px; display:flex">
    <button class="btn btn-primary rounded-circle" style="width: 50px; height: 50px;" onclick="createPool()"> + </button>
    <span style="margin-top: 15px; margin-left: 10px"><h2> Créer un nouveau pool</h2></span>
  </div>
  {{#each pools as |pool|}}
    <div class="col-12 col-md-12 col-lg-4 card-competence">
      <div class="card">
        <div class="card-header header-spacing">
          <div class="row">
            <div class="col-md-10">
              <h3 class="card-title"><i class="fal fa-school"></i> {{pool.name}}</h3>
            </div>
            <div class="col-md-2">
              <div class="custom-control custom-switch">
                <input type="checkbox" class="custom-control-input" name="poolActive" data-pool="{{pool.id}}" id="{{pool.id}}" {{#ifCond pool.active '===' true}} checked {{/ifCond}} onclick="changeState(this)">
                <label class="custom-control-label" for="{{pool.id}}"></label>
              </div>
            </div>
          </div>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-lg-5" >
              <a href="#">
                <button class="btn btn-outline-primary" style="width:100%"> Volontaires </button>
              </a>
            </div>
            <div class="col-lg-5">
              <a href="#">
                <button class="btn btn-outline-primary" style="width:100%" data-pool="{{pool.id}}" onclick="poolInvitation(this)"> Inviter </button>
              </a>
            </div>
            <div class="col-lg-2">
              <a href="#">
                <button class="btn btn-outline-secondary" style="width:100%" data-pool="{{pool.id}}" onclick="editPool(this)"> <i class="fal fa-cog"></i> </button>
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
  {{/each}}
</div>
<script>
  let es_id = [];
  {{#each group as |es|}}
    console.log('{{es.es_id}}');
  {{/each}}
  console.log(es_id);
  let createPool = () => {
    createModal({
      id: 'createPoolModal',
      modal: 'es/createPool',
      title: 'Créer un pool de remplaçants'
    }, () => {
      $('button#createPoolButton').click(function () {
        if ($('#personnelMails').val() !== '') { // && $('#personnelMails').val() !== [] TODO: Comprendre pourquoi cette comparaison ne fonctionne pas
          let _csrf = $('meta[name="csrf-token"]').attr('content');
          let pool = $('#poolName').val();
          let allEs = $('#groupToggle').prop('checked');
          console.log(allEs);
          let selectedEs = $('#esNameSelect').val();
          let referent = $('#referentName').val();
          let mails = $('#personnelMails').val();
          $.post(`/my-pool`, {
            _csrf,
            selectedEs,
            allEs,
            pool,
            referent,
            mails
          }, () => {
            window.location.href = "/my-pool";
          })
        }
      });
    });
  };
  let editPool = (poolToEdit) => {
    createModal({
      id: 'editPoolModal',
      modal: 'es/editPool',
      title: 'Modifier un pool de remplaçant'
    }, () => {
      $('button#editPoolButton').click(function () {
        let _csrf = $('meta[name="csrf-token"]').attr('content');
        let name = $('#newPoolName').val();
        let referent = $('#newReferentName').val();
        let pool = poolToEdit.dataset.pool;
        $.put(`/my-pool`, {
          _csrf,
          pool,
          referent,
          name
        }, (response) => {
          if (response === 'Modifications done') {
            $('#editPoolModal').modal('hide');
            notification({
              icon: 'check-circle',
              type: 'success',
              title: 'Modifications effectuées',
              message: ``
            });
          }
        })
      });
      $('button#deletePoolButton').click(function () {
        $('#editPoolModal').modal('hide');
        createModal({
            id: 'removePoolModal',
            modal: 'es/removePool',
            title: 'Supprimer un pool de remplaçants'
        }, () => {
          $('#confirmRemoveButton').click(function () {
            let _csrf = $('meta[name="csrf-token"]').attr('content');
            let pool = poolToEdit.dataset.pool;
            $.delete(`/my-pool`, {
              _csrf,
              pool
            }, (response) => {
              if (response === 'Pool removed') {
                $('#removePoolModal').modal('hide');
                location.reload();
                notification({
                  icon: 'check-circle',
                  type: 'success',
                  title: 'Pool supprimé avec succès',
                  message: ``
                });
              }
            })
          });
        });
      });
    });
  };
  let poolInvitation = (selectedPool) => {
    createModal({
      id: 'invitePoolModal',
      modal: 'es/poolInvitation',
      title: 'Inviter des soignants'
    }, () => {
      $('button#createPoolButton').click(function () {
        if ($('#newPersonnelMails').val() !== '') { // && $('#personnelMails').val() !== [] TODO: Comprendre pourquoi cette comparaison ne fonctionne pas
          let mails = $('#newPersonnelMails').val();
          let _csrf = $('meta[name="csrf-token"]').attr('content');
          let pool_id = selectedPool.dataset.pool;
          $.post(`/pool-invite`, {
            _csrf,
            mails,
            pool_id
          }, (response) => {
            if (response === 'Invitations sent') {
              $('#invitePoolModal').modal('hide');
              notification({
                icon: 'check-circle',
                type: 'success',
                title: 'Invitation(s) envoyée(s)',
                message: ``
              });
            }
          });
        }
      });
    })
  };
  let personnelStep = () => {
    if ($('#p5oolName').val() !== '' && $('#referentName').val() !== '')
    {
      $('#addPersonnelButton').toggle();
      $('#label').toggle();
      $('#label2').toggle();
      $('#label3').toggle();
      $('#esNameDiv').hide();
      $('#toggleDiv').hide();
      $('#referentName').toggle();
      $('#poolName').toggle();
      $('#createPoolButton').toggle();
      $('#personnelMails').multiple_emails({
        position: 'top',
        theme: 'bootstrap',
        checkDupEmail: true
      });
    }
  };
  let changeState = (selectedToggle) => {
    let _csrf = $('meta[name="csrf-token"]').attr('content');
    let checked = selectedToggle.checked;
    let pool = selectedToggle.dataset.pool;
    if (checked === true) {
      $.post(`/pool-enable`, {
        _csrf,
        checked,
        pool
      }, (response) => {
        if (response === 'pool unabled') {
          notification({
            icon: 'check-circle',
            type: 'success',
            title: 'Pool activé',
            message: ``
          })
        }
      })
    }
    if (checked === false) {
      $.post(`/pool-disable`, {
        _csrf,
        checked,
        pool
      }, (response) => {
        if (response === 'pool disabled') {
          notification({
            icon: 'check-circle',
            type: 'success',
            title: 'Pool désactivé',
            message: ``
          })
        }
      })
    }
  };
  const hideEsList = () => {
    $('#esNameDiv').toggle();
  };
</script>