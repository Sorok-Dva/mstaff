<link href="https://gitcdn.github.io/bootstrap-toggle/2.2.2/css/bootstrap-toggle.min.css" rel="stylesheet">
<script src="https://gitcdn.github.io/bootstrap-toggle/2.2.2/js/bootstrap-toggle.min.js"></script>

<style>
  .class-icon {
    text-align: center;
    margin-top: 15px;
  }
  .header-spacing {
    margin-top: 15px;
  }
  .toggle.ios, .toggle-on.ios, .toggle-off.ios {
    border-radius: 20px;
    background-color: #D8D8D8;
  }
</style>

{{ user.options}}

<div class="col-md-12 text-center">
{{#ifCond pools.length '<=' 0}}
    <h2 style="font-weight: 400"> Vous n'avez pas encore crée de pool de remplaçants. </h2>
{{else}}
  <h2 style="font-weight: 400">Il y a actuellement {{ @root.pools.length }} pool{{#ifCond @root.pools.length '>' 1}}s{{/ifCond}}.</h2>
{{/ifCond}}
</div>

<div class="row">
  <div class="col-12 col-md-12 col-lg-12" style="margin-bottom: 25px; display:flex">
    <button class="btn btn-primary rounded-circle" style="width: 50px; height: 50px;" data-group="{{group}}" onclick="createPool(this)"> + </button>
    <span style="margin-top: 15px; margin-left: 10px"><h2> Créer un nouveau pool</h2></span>
  </div>
  {{#each pools as |pool|}}
    <div class="col-12 col-md-12 col-lg-4 card-competence">
      <div class="card">
        <div class="card-header header-spacing">
          <div class="row">
            <div class="col-md-6">
              <h3 class="card-title"><i class="fal fa-school"></i> {{pool.name}}</h3>
            </div>
          </div>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-lg-5" >
              <a href="#">
                <button class="btn btn-outline-primary" style="width:100%" onclick="poolUsersList(this)"> Volontaires </button>
              </a>
            </div>
            <div class="col-lg-5">
              <a href="#">
                <button class="btn btn-outline-primary" style="width:100%" data-pool="{{pool.id}}" onclick="poolInvitation(this)"> Inviter </button>
              </a>
            </div>
            <div class="col-lg-2">
              <a href="#">
                <button class="btn btn-outline-secondary" style="width:100%" data-pool="{{pool.id}}" data-name="{{pool.name}}"
                        data-referent="{{pool.referent}}" onclick="editPool(this)"> <i class="fal fa-cog"></i> </button>
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
  {{/each}}
</div>
<script>
  let createPool = (data) => {
    createModal({
      id: 'createPoolModal',
      modal: 'es/createPool',
      title: 'Créer un pool de remplaçants',
    }, () => {
      $('button#createPoolButton').click(function () {
        if ($('#personnelMails').val() !== '') {
          let _csrf = $('meta[name="csrf-token"]').attr('content');
          let pool = $('#poolName').val();
          let referent = $('#referentName').val();
          let mails = $('#personnelMails').val();

         $.post(`/my-pool`, {
            _csrf,
            pool,
            referent,
            mails
          }, () => {
           location.reload();
          })
        } else {
          notification({
            icon: 'flag',
            type: 'warning',
            title: 'Vous devez entrer au moins une addresse e-mail.',
            message: ``
          });
        }
      });
    });
  };
  let poolUsersList = (poolToEdit) => {

  };
  let editPool = (poolToEdit) => {
    createModal({
      id: 'editPoolModal',
      modal: 'es/editPool',
      title: 'Modifier un pool de remplaçant',
      name: poolToEdit.dataset.name,
      referent: poolToEdit.dataset.referent
    }, () => {
      $('button#editPoolButton').click(function () {
        let _csrf = $('meta[name="csrf-token"]').attr('content');
        let name = $('#newPoolName').val();
        let referent = $('#newReferentName').val();
        let pool = poolToEdit.dataset.pool;
        $.put(`/my-pool`, {
          _csrf,
          pool,
          referent,
          name
        }, (response) => {
          if (response === 'Modifications done') {
            location.reload();
          }
        })
      });
      $('button#deletePoolButton').click(function () {
        $('#editPoolModal').modal('hide');
        createModal({
            id: 'removePoolModal',
            modal: 'es/removePool',
            title: 'Supprimer un pool de remplaçants'
        }, () => {
          $('#confirmRemoveButton').click(function () {
            let _csrf = $('meta[name="csrf-token"]').attr('content');
            let pool = poolToEdit.dataset.pool;
            $.delete(`/my-pool`, {
              _csrf,
              pool
            }, (response) => {
              if (response === 'Pool removed') {
                $('#removePoolModal').modal('hide');
                location.reload();
                notification({
                  icon: 'check-circle',
                  type: 'success',
                  title: 'Pool supprimé avec succès',
                  message: ``
                });
              }
            })
          });
        });
      });
    });
  };
  let poolInvitation = (selectedPool) => {
    createModal({
      id: 'invitePoolModal',
      modal: 'es/poolInvitation',
      title: 'Inviter des soignants',
      pool_id: selectedPool.dataset.pool,
    }, () => {
      $('button#createPoolButton').click(function () {
        if ($('#newPersonnelMails').val() !== '') { // && $('#personnelMails').val() !== [] TODO: Comprendre pourquoi cette comparaison ne fonctionne pas
          let mails = $('#newPersonnelMails').val();
          let _csrf = $('meta[name="csrf-token"]').attr('content');
          let pool_id = selectedPool.dataset.pool;
          $.post(`/pool/${pool_id}/invites`, {
            _csrf,
            mails,
          }, (response) => {
            if (response === 'Invitations sent') {
              $('#invitePoolModal').modal('hide');
              notification({
                icon: 'check-circle',
                type: 'success',
                title: 'Invitation(s) envoyée(s)',
                message: ``
              });
            }
          });
        }
      });
    })
  };
  let personnelStep = () => {
    if ($('#poolName').val() !== '' && $('#referentName').val() !== '')
    {
      $('#addPersonnelButton').toggle();
      $('#poolNameLabel').toggle();
      $('#referentNameLabel').toggle();
      $('#personnelMailsLabel').toggle();
      $('#esNameDiv').hide();
      $('#toggleDiv').hide();
      $('#referentName').toggle();
      $('#poolName').toggle();
      $('#createPoolButton').toggle();
      $('#personnelMails').multiple_emails({
        position: 'top',
        theme: 'bootstrap',
        checkDupEmail: true
      });
    } else {
      notification({
        icon: 'flag',
        type: 'warning',
        title: 'Vous devez entrer le nom de votre pool ainsi que le nom du référent.',
        message: ``
      });
    }
  };
</script>