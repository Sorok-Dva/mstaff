let map,marker,cityCircle,filter,markers=[],pos={lat:0,lng:0,rayon:5},selectedAll=!1,allEs=[],application={},kmArray=[1,2,5,10,15,20,30,50,70,100],slider=document.getElementById("radius");$('#step1 input[type="checkbox"]').change(function(){let e=$(this).attr("name"),t=($(this).parent().closest(".sub-step").closest(".tab-pane").attr("id"),$(this).parent().closest(".sub-step").attr("id"));if(this.checked)switch($(`#${t}`).find(":input").not(`[name=${e}]`).prop("checked",!1),e){case"cdi-cdd":application.contractType={name:e,value:"CDI / CDD"},delete application.liberal,$("#activityType").show(),$("#timeType").show(),$("#liberalType").hide();break;case"vacation":application.contractType={name:e,value:"VACATION"},delete application.activityType,delete application.timeType,$("#liberalType").show(),resetContract(e);break;case"internship":application.contractType={name:e,value:"STAGE"},delete application.activityType,delete application.timeType,delete application.liberal,$("#liberalType").hide(),resetContract(e);break;case"full_time":application.activityType={name:e,value:"TEMPS PLEIN"};break;case"part_time":application.activityType={name:e,value:"TEMPS PARTIEL"};break;case"daytime":application.timeType={name:e,value:"fa-sun-o"};break;case"nighttime":application.timeType={name:e,value:"fa-moon-o"};break;case"liberal":application.liberal={name:e,value:"Oui"}}else{switch(t){case"contracts":delete application.contractType,delete application.activityType,delete application.timeType,delete application.liberal}"cdi-cdd"===e&&($(`#${t}`).find(":input").prop("checked",!1),$("#activityType").hide(),$("#timeType").hide()),"vacation"===e&&($(`#${t}`).find(":input").prop("checked",!1),$("#liberalType").hide())}}),$("#radius").on("click","li",function(){$("#radius-slider .slider").val($(this).attr("data-step")),highlightLabel(slider.noUiSlider.get())});let resetContract=e=>{$("#step1").find(":input").not(`[name=${e}]`).prop("checked",!1),$("#activityType").hide(),$("#timeType").hide()},geoSuccess=e=>{pos={lat:e.coords.latitude,lng:e.coords.longitude,rayon:5},getEsList()},mapInit=()=>{document.getElementById("map")&&(map=new google.maps.Map(document.getElementById("map"),{zoom:10,center:pos}),marker=new google.maps.Marker({position:pos,map:map}),cityCircle=new google.maps.Circle({strokeColor:"#337AB7",strokeOpacity:.8,strokeWeight:2,fillColor:"#5BBBE5",fillOpacity:.35,map:map,center:pos,radius:1e3*pos.rayon||1e4}))},addMarker=e=>{let t=new google.maps.Marker({map:map,position:{lat:e.lat,lng:e.lon},icon:{url:"http://maps.gstatic.com/mapfiles/circle.png",anchor:new google.maps.Point(10,10),scaledSize:new google.maps.Size(10,17)}});markers.push(t),google.maps.event.addListener(t,"click",function(){var i=new google.maps.InfoWindow;i.setContent(e.name),i.open(map,t)})},removeAllMarker=()=>{markers.forEach((e,t)=>{e.setMap(null)})},getEsList=()=>{mapInit();let e=$("#csrfToken").val();$("#esCount").empty(),$("#esList").html('<div id="loader" class="col-md-12"></div>'),$("#loader").show(),$.post("/api/establishments/findByGeo",{rayon:pos.rayon,lat:pos.lat,lon:pos.lng,filter:filter,_csrf:e},e=>{allEs=e,loadTemplate("/static/views/api/findByGeo.hbs",e,t=>{$("#esList").html(t),$(".esCount").html(e.length),$("#loader").hide()})})},highlightLabel=e=>{$("#radius-slider .slider-labels li").removeClass("slideActive");let t=parseInt(e);$("#radius-slider .slider-labels li:nth-child("+t+")").addClass("slideActive")},addEs=e=>{let t=parseInt(e.finess_et);-1===application.selectedES.indexOf(t)&&($(`i.selectEs[data-id="${e.id}"]`).hide(),$(`i.unselectEs[data-id="${e.id}"]`).show(),application.selectedES.push(t),$("#selectedEsCount").html(application.selectedES.length),$("#es_selected").append($(`#es${e.id}`).clone().attr("class","col-md-3")))},removeEs=e=>{let t=parseInt(e.finess_et),i=application.selectedES.indexOf(t);-1!==i&&($(`i.unselectEs[data-id="${e.id}"]`).hide(),$(`i.selectEs[data-id="${e.id}"]`).show(),application.selectedES.splice(i,1),$("#selectedEsCount").html(application.selectedES.length),$(`#es_selected > #es${e.id}`).remove())},verifyStep=(e,t)=>{let i=!1;switch(e){case 1:if("contractType"in application?"cdi-cdd"!==application.contractType.name||"activityType"in application&&"timeType"in application||(notification({icon:"exclamation",type:"danger",title:"Informations manquantes :",message:"Merci d'indiquer le type d'activité et votre aménagement horaire."}),i=!0):(notification({icon:"exclamation",type:"danger",title:"Informations manquantes :",message:"Merci de choisir un type de contrat."}),i=!0),"postType"in application&&0!==application.postType.length||(notification({icon:"exclamation",type:"danger",title:"Informations manquantes :",message:"Merci de choisir au moins un type de poste."}),i=!0),i)return!1;t.next().removeClass("disabled"),nextTab(t);break;case 2:if("vacation"===application.contractType.name||"start"in application||"end"in application?"vacation"===application.contractType.name||"start"in application?"vacation"===application.contractType.name||"end"in application||(notification({icon:"exclamation",type:"danger",title:"Informations manquantes :",message:"Merci de choisir une date de fin."}),i=!0):(notification({icon:"exclamation",type:"danger",title:"Informations manquantes :",message:"Merci de choisir une date de début."}),i=!0):(notification({icon:"exclamation",type:"danger",title:"Informations manquantes :",message:"Merci de choisir vos dates."}),i=!0),i)return!1;application.selectedES=[],t.next().removeClass("disabled"),nextTab(t);break;case 3:if("selectedES"in application&&!(application.selectedES.length<1)||(notification({icon:"exclamation",type:"danger",title:"Erreur :",message:"Veuillez sélectionner au moins un établissement."}),i=!0),i)return!1;if($("#recapContractType").find("h3").html(application.contractType.value),"cdi-cdd"===application.contractType.name){let e=application.contractType.value.toLowerCase(),t=$(".from").val(),i=$(".to").val();$("#recapActivityType").show().find("h3").html(application.activityType.value),$("#recapHourType").show().find("i").attr("class",`fa ${application.timeType.value} fa-3x`),$("#recapLiberal").hide(),$("#availability").html(`<h4 style="text-align: center;">Mon ${e} commence le ${t} et se termine le ${i}</h4>`)}else if("vacation"===application.contractType.name){let e=application.liberal?"Oui":"Non";$("#recapActivityType").hide().find("h3").html(""),$("#recapHourType").hide(),$("#recapLiberal").show().find("h3").html(e)}else $("#recapActivityType").hide().find("h3").html(""),$("#recapHourType").hide(),$("#recapLiberal").hide().find("h3").html("");$('#es_selected > div[data-type="es"]').each((e,t)=>{let i=$(t).find("h5 > span").text(),a=$(t).attr("data-es_type"),n=$(t).find("h6").text();$("#finalESList").append(`<tr><td>${i}</td><td>${a}</td><td>${n}</td></tr>`)}),t.next().removeClass("disabled"),nextTab(t),application.valid=!0}},selectAll=()=>{!0===(selectedAll=!selectedAll)?($("#esList i.selectEs").hide(),$("#esList i.unselectEs").show(),$("#es_selected").append($("#esList .es-card").clone().attr("class","col-md-3")),allEs.map((e,t)=>{application.selectedES.push(parseInt(e.finess_et))})):($("#esList i.unselectEs").hide(),$("#esList i.selectEs").show(),$("#es_selected > .es-card").remove(),allEs.map((e,t)=>{let i=application.selectedES.indexOf(parseInt(e.finess_et));-1!==i&&application.selectedES.splice(i,1)})),$("#selectedEsCount").html(application.selectedES.length)},addWish=()=>{if(application.valid){let e={name:application.name,contractType:application.contractType.name,fullTime:"activityType"in application&&"full_time"===application.activityType.name,partTime:"activityType"in application&&"part_time"===application.activityType.name,dayTime:"timeType"in application&&"daytime"===application.timeType.name,nightTime:"timeType"in application&&"nighttime"===application.timeType.name,liberal:!!application.liberal,availability:application.availability,start:application.start,end:application.end,lat:pos.lat,lon:pos.lng,es:application.selectedES.toString(),es_count:application.selectedES.length,posts:application.postType,_csrf:_csrf};$.post("/api/candidate/wish/add",e,e=>{e.wish?$(location).attr("href","/applications"):notification({icon:"exclamation",type:"danger",title:"Une erreur est survenue :",message:"Impossible d'ajouter votre souhait, veuillez réessayer ou contacter notre assistance si le problème persiste."})})}};noUiSlider.create(slider,{start:3,step:1,connect:"lower",range:{min:1,max:10},serialization:{format:{decimals:0}}}),slider.noUiSlider.on("change",function(){pos.rayon=kmArray[parseInt(slider.noUiSlider.get())-1],highlightLabel(parseInt(slider.noUiSlider.get())),getEsList()}),slider.noUiSlider.on("slide",function(){highlightLabel(parseInt(slider.noUiSlider.get()))}),$(document).ready(function(){navigator.geolocation?navigator.geolocation.getCurrentPosition(geoSuccess):alert("Geolocation is not supported by this browser."),$("#selectPostType").select2(),$("#geolocationFilter").select2({dropdownAutoWidth:!0}),$("#selectPostType").on("change",e=>{let t=$("#selectPostType").select2("data");application.postType=[],t.forEach(e=>{application.postType.push(e.text)})}),$("#geolocationFilter").on("select2:select",e=>{let t=$("#geolocationFilter").select2("data");return filter=null,t.length>0&&(filter=[],t.forEach((e,t)=>{filter.push(parseInt(e.id))})),getEsList()}).on("select2:unselect",e=>{let t=$("#geolocationFilter").select2("data");if(filter.length>0)return filter=[],t.forEach((e,t)=>{filter.push(parseInt(e.id))}),getEsList()}),$(".from").on("dp.change",e=>{application.start=new Date(e.date)||null}),$(".to").on("dp.change",e=>{application.end=new Date(e.date)||null}),$(".next-step").click(function(e){let t=$(".wizard .nav-tabs li.active");verifyStep(parseInt($(this).attr("data-step")),t)}),$(".prev-step").click(function(e){let t=$(".wizard .nav-tabs li.active");prevTab(t)})});