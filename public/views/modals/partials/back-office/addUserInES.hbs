<div class="modal-body">
  <div class="col-md-12 alertUserExists" style="display: none">
    <h6 class="text-center text-success">Un utilisateur avec cet email existe déjà. Spécifiez juste son rôle pour cet établissement.</h6>
  </div>
  <div class="row">
    <div class="form-group">
      <label for="AUemail" class="col-md-4 control-label">Email</label>
      <div class="col-md-8">
        <input type="text" name="AUemail" class="form-control" id="AUemail">
      </div>
    </div>
    <div class="form-group toHide">
      <label for="AUlastName" class="col-md-4 control-label">Nom</label>
      <div class="col-md-8">
        <input type="text" name="AUlastName" class="form-control" id="AUlastName">
      </div>
    </div>
    <div class="form-group toHide">
      <label for="AUfirstName" class="col-md-4 control-label">Prénom</label>
      <div class="col-md-8">
        <input type="text" name="AUfirstName" class="form-control" id="AUfirstName">
      </div>
    </div>
    <div class="form-group toHide">
      <label for="AUphone" class="col-md-4 control-label">Téléphone</label>
      <div class="col-md-8">
        <input type="tel" name="AUphone" class="form-control" id="AUphone">
      </div>
    </div>
    <div class="form-group">
      <label for="role" class="col-md-4 control-label">Rôle</label>
      <div class="col-md-8">
        <select name="role" id="role" class="form-control">
          <option value="Admin">Administrateur</option>
          <option value="DRH">DRH</option>
          <option value="User">Utilisateur</option>
        </select>
      </div>
    </div>
    <input type="hidden" name="es_id" value="32">
  </div>
</div>
<div class="modal-footer">
  <button type="button" class="btn btn-default" id="addUserInModal"> Ajouter l'utilisateur</button>
</div>
<script>
  $('#AUemail').blur(() => {
    let email = $('#AUemail').val();
    $.get(`/api/user/emailAvailable/${email}`, (result) => {
      if (!result.available) {
        $('.toHide').hide();
        $('.alertUserExists').show();
        userExists = true;
      } else {
        $('.toHide').show();
        $('.alertUserExists').hide();
        userExists = false;
      }
    }).catch(error => {
      $('.toHide').show();
      $('.alertUserExists').hide();
      userExists = false;
    });
  });

  $('#addUserInModal').click(function() {
    let user = {};

    user.email = $('input[name="AUemail"]').val();
    user.role = $('select[name="role"] option').filter(":selected").val();
    user._csrf = $('#csrfToken').val();

    if (!userExists) {
      user.firstName = $('input[name="AUfirstName"]').val();
      user.lastName = $('input[name="AUlastName"]').val();
      user.phone = $('input[name="AUphone"]').val();
    }

    $.post('/api/back-office/establishment/{{this.esId}}/add/user', user, (data) => {
      if (data.status === 'Already exists') {
        notification({
          icon: 'exclamation',
          type: 'danger',
          title: 'Utilisateur déjà présent dans cet établissement.',
        });
      } else if (data.status === 'Not an ES account') {
        notification({
          icon: 'exclamation',
          type: 'danger',
          title: 'Utilisateur non ajouté à l\'établissement:',
          message: `Cet utilisateur existe déjà avec un autre type de compte (${data.user.type}) et ne peut donc pas être ajouté à un établissement.`
        });
      } else {
        $('#addUserInESModal').modal('hide');
        $('#esUsers').append(`<li>${data.user.firstName} ${data.user.lastName} [${data.esaccount.role}]`);
        notification({
          icon: 'check-circle',
          type: 'success',
          title: 'Utilisateur ajouté à l\'établissement.'
        });
      }
    });
  });
</script>